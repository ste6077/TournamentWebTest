@using TournamentLibrary.Goals
@using TournamentLibrary.Matches

@* MatchControl.razor *@
<div class="container py-3">
    <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-bold">Ablauf Nr</span>
                <span class="form-label mb-1" style="width: 90px;">@ScheduleNumber</span>
                <span class="fw-bold">Spiel Nr</span>
                <span class="form-label mb-1" style="width: 90px;">@MatchNumber</span>
                <span class="fw-bold">Spiel Info</span>
                <span class="form-label mb-1" style="width: 90px;">@GroupText</span>
            </div>

            <button class="btn btn-primary btn-sm"
                    @onclick="OnNextMatchClicked">
                Nächstes Match setzen
            </button>
        </div>

        <div class="card-body">
            <div class="row g-3 align-items-stretch">
                <!-- Team A -->
                <div class="col-12 col-md-5">
                    <div class="border rounded p-3 h-100">
                        <div class="d-flex align-items-center gap-3">
                            <img src="@TeamALogoSrc"
                                 alt="Logo Team A"
                                 style="width:64px;height:64px;object-fit:contain;"
                                 class="border rounded" />
                            <div class="flex-grow-1">
                                <label class="form-label mb-1">Name Team A</label>
                                <div class="form-label">@TeamAName</div>
                            </div>

                            <div class="text-end">
                                <div class="small text-muted">Tore</div>
                                <div class="display-6 mb-0">@GoalsA</div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-success w-50"
                                    @onclick="OnAddGoalA">
                                + Tor Team A
                            </button>
                            <button class="btn btn-outline-danger w-50"
                                    @onclick="OnRemoveGoalA">
                                - Tor Team A
                            </button>
                        </div>

                    </div>
                </div>

                <!-- Center: Match actions -->
                <div class="col-12 col-md-2">
                    <div class="border rounded p-3 h-100 d-flex flex-column gap-2">
                        <div class="text-center">
                            <div class="small text-muted">Match-Status</div>
                            <div class="fw-bold">@Status</div>
                            <div class="small text-muted mt-2">Zeit</div>
                            <div class="fw-bold">@TimeDisplay</div>
                        </div>

                        <hr class="my-2" />

                        <button class="btn btn-success btn-sm"
                                @onclick="OnStartClicked">
                            Start
                        </button>

                        <button class="btn btn-warning btn-sm"
                                @onclick="OnPauseClicked">
                            Pause
                        </button>

                        <button class="btn btn-info btn-sm"
                                @onclick="OnContinueClicked">
                            Continue
                        </button>

                        <button class="btn btn-danger btn-sm"
                                @onclick="OnStopClicked">
                            Stop
                        </button>

                        <hr class="my-2" />

                        <button class="btn btn-outline-secondary btn-sm"
                                @onclick="OnSimulateClicked">
                            Simulieren
                        </button>

                        <button class="btn btn-outline-primary btn-sm"
                                @onclick="OnTimeTo5sClicked">
                            Zeit auf 5s setzen
                        </button>
                    </div>
                </div>

                <!-- Team B -->
                <div class="col-12 col-md-5">
                    <div class="border rounded p-3 h-100">
                        <div class="d-flex align-items-center gap-3">
                            <img src="@TeamBLogoSrc"
                                 alt="Logo Team B"
                                 style="width:64px;height:64px;object-fit:contain;"
                                 class="border rounded" />
                            <div class="flex-grow-1">
                                <label class="form-label mb-1">Name Team B</label>
                                <div class="form-label">@TeamBName</div>
                            </div>

                            <div class="text-end">
                                <div class="small text-muted">Tore</div>
                                <div class="display-6 mb-0">@GoalsB</div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-success w-50"
                                    @onclick="OnAddGoalB">
                                + Tor Team B
                            </button>
                            <button class="btn btn-outline-danger w-50"
                                    @onclick="OnRemoveGoalB">
                                - Tor Team B
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Ergebnis setzen -->
            <div class="mt-4 border rounded p-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div class="fw-bold">Ergebnis setzen</div>
                    <div class="small text-muted">Zwei numerische Auswahlmöglichkeiten + Button</div>
                </div>

                <div class="row g-2 align-items-end mt-1">
                    <div class="col-12 col-md-4">
                        <label class="form-label mb-1">Team A Ergebnis</label>
                        <input class="form-control"
                               type="number"
                               min="0"
                               @bind="SetResultA" />
                    </div>

                    <div class="col-12 col-md-4">
                        <label class="form-label mb-1">Team B Ergebnis</label>
                        <input class="form-control"
                               type="number"
                               min="0"
                               @bind="SetResultB" />
                    </div>

                    <div class="col-12 col-md-4">
                        <button class="btn btn-dark w-100"
                                @onclick="OnApplyResultClicked">
                            Ergebnis übernehmen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // --- UI State / Binding ---
    private int ScheduleNumber => CurrentMatch != null ? CurrentMatch.ScheduleNumber : -1;
    private string MatchNumber => CurrentMatch != null ? CurrentMatch.FixtureNumberAsText : "tba";
    private string GroupText => CurrentMatch != null ? CurrentMatch.GroupName : "tba";

    private string TeamAName => CurrentMatch != null ? CurrentMatch.NameTeamA : "Team A";
    private string TeamBName => CurrentMatch != null ? CurrentMatch.NameTeamB : "Team B";

    private int GoalsA => CurrentMatch != null ? (int)CurrentMatch.ScoreA : 0;
    private int GoalsB => CurrentMatch != null ? (int)CurrentMatch.ScoreB : 0;

    private TimeSpan Clock { get; set; } = TimeSpan.Zero;

    // Ergebnis setzen
    private int SetResultA { get; set; }
    private int SetResultB { get; set; }

    private string LastAction { get; set; } = "";

    private string Status => CurrentMatch != null ? CurrentMatch.StateGermanText : "Unknown";
    private string TimeDisplay { get; set; } = "00:00";

    private string TeamALogoSrc { get; set; } = "";
    private string TeamBLogoSrc { get; set; } = "";

    private static string GetImageSrc(string? base64)
    {
        
        if (string.IsNullOrWhiteSpace(base64))
            return "images/placeholder.png";

        return $"data:image/png;base64,{base64}";
    }

    [Parameter] public Match? CurrentMatch { get; set; }
    private Match? _tmpMatch;

    [Parameter] public EventCallback OnNextMatch { get; set; }
    [Parameter] public EventCallback OnAddGoalTeamA { get; set; }
    [Parameter] public EventCallback OnRemoveGoalTeamA { get; set; }
    [Parameter] public EventCallback OnAddGoalTeamB { get; set; }
    [Parameter] public EventCallback OnRemoveGoalTeamB { get; set; }

    [Parameter] public EventCallback OnStart { get; set; }
    [Parameter] public EventCallback OnPause { get; set; }
    [Parameter] public EventCallback OnContinue { get; set; }
    [Parameter] public EventCallback OnStop { get; set; }

    [Parameter] public EventCallback OnSimulate { get; set; }
    [Parameter] public EventCallback OnSimulateStage1 { get; set; }
    [Parameter] public EventCallback OnSimulateStage2 { get; set; }
    [Parameter] public EventCallback OnSimulatePlayoffs { get; set; }
    [Parameter] public EventCallback OnSetTimeTo5s { get; set; }
    [Parameter] public EventCallback<(int, int)> OnApplyResult { get; set; }

    private Task OnNextMatchClicked() => OnNextMatch.InvokeAsync();
    private Task OnAddGoalA() => OnAddGoalTeamA.InvokeAsync();
    private Task OnRemoveGoalA() => OnRemoveGoalTeamA.InvokeAsync();
    private Task OnAddGoalB() => OnAddGoalTeamB.InvokeAsync();
    private Task OnRemoveGoalB() => OnRemoveGoalTeamB.InvokeAsync();

    private Task OnStartClicked() => OnStart.InvokeAsync();
    private Task OnPauseClicked() => OnPause.InvokeAsync();
    private Task OnContinueClicked() => OnContinue.InvokeAsync();
    private Task OnStopClicked() => OnStop.InvokeAsync();

    private Task OnSimulateClicked() => OnSimulate.InvokeAsync();
    private Task OnSimulateStage1Clicked() => OnSimulateStage1.InvokeAsync();
    private Task OnSimulateStage2Clicked() => OnSimulateStage2.InvokeAsync();
    private Task OnSimulatePlayoffsClicked() => OnSimulatePlayoffs.InvokeAsync();
    private Task OnTimeTo5sClicked() => OnSetTimeTo5s.InvokeAsync();
    private Task OnApplyResultClicked() => OnApplyResult.InvokeAsync((SetResultA, SetResultB));

    protected override void OnInitialized()
    {
        TeamALogoSrc = GetImageSrc(CurrentMatch != null && CurrentMatch.HasTeamA() ? CurrentMatch.TeamA.Base64LogoBig : string.Empty);
        TeamBLogoSrc = GetImageSrc(CurrentMatch != null && CurrentMatch.HasTeamB() ? CurrentMatch.TeamB.Base64LogoBig : string.Empty);
    }

    protected override void OnParametersSet()
    {
        if (_tmpMatch != CurrentMatch && CurrentMatch is not null)
        {
            if (_tmpMatch != null)
            {
                _tmpMatch.Goals_Changed -= CurrentMatch_GoalsChanged;
            }

            // Falls du TimeDisplay nicht via @ref setzt:
            var t = CurrentMatch.Settings.Time;
            TimeDisplay = $"{t.Minutes:00}:{t.Seconds:00}";

            CurrentMatch.Goals_Changed += CurrentMatch_GoalsChanged;
            
            Console.WriteLine($"GetImage triggered: {CurrentMatch.TeamA.Base64LogoBig.Length} | {CurrentMatch.TeamA.Base64LogoSmallGray.Length}");
            TeamALogoSrc = GetImageSrc(CurrentMatch != null && CurrentMatch.HasTeamA() ? CurrentMatch.TeamA.Base64LogoBig : string.Empty);
            TeamBLogoSrc = GetImageSrc(CurrentMatch != null && CurrentMatch.HasTeamB() ? CurrentMatch.TeamB.Base64LogoBig : string.Empty);
            _tmpMatch = CurrentMatch;
        }
    }

    private void CurrentMatch_GoalsChanged(object sender, GoalEventArgs eventArgs)
    {
        RefreshUI();
    }

    // --- Actions (hier später an Service/SignalR/API anbinden) ---
    public void SetMatch(Match match)
    {
        if (CurrentMatch != match)
        {
            CurrentMatch = match;
            SetTimestamp(CurrentMatch.Settings.Time);
            RefreshUI();
        }
    }

    public void SetTimestamp(TimeSpan stamp)
    {
        TimeDisplay = $"{stamp.Minutes:00}:{stamp.Seconds:00}.{stamp.Milliseconds:00}";
        RefreshUI();
    }

    public void RefreshUI()
    {
        _ = InvokeAsync(StateHasChanged);
    }
}
